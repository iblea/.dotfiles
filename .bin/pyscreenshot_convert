#!/usr/bin/env python3
"""
스크린샷 변환 및 리사이즈 스크립트

입력 파일 타입에 따라 동작:
- 확장자 없음 또는 .json: JSON에서 base64 추출 → PNG 변환 → 리사이즈
- 이미지 파일 (.png, .jpg 등): 리사이즈만 진행

Usage:
    python3 screenshot_convert.py <input_file> [output] [--resize WIDTH]

Examples:
    python3 screenshot_convert.py screenshot.json
    python3 screenshot_convert.py screenshot.json output.png --resize 960
    python3 screenshot_convert.py image.png --resize 960
    python3 screenshot_convert.py toolu_01ABC123 output.png --resize 960
"""

import sys
import json
import base64
import subprocess
import argparse
from pathlib import Path

# 이미지 확장자 목록
IMAGE_EXTENSIONS = {'.png', '.jpg', '.jpeg', '.gif', '.bmp', '.tiff', '.webp'}


def is_image_file(file_path: str) -> bool:
    """파일이 이미지 파일인지 확인"""
    suffix = Path(file_path).suffix.lower()
    return suffix in IMAGE_EXTENSIONS


def is_json_file(file_path: str) -> bool:
    """파일이 JSON 파일인지 확인 (확장자 없음 포함)"""
    suffix = Path(file_path).suffix.lower()
    return suffix == '.json' or suffix == ''


def convert_json_to_png(json_path: str, output_path: str = None) -> str:
    """JSON 파일에서 base64 이미지 데이터를 추출하여 PNG로 저장"""
    with open(json_path, 'r') as f:
        data = json.load(f)

    # base64 데이터 추출
    base64_data = data[0]['source']['data']
    image_data = base64.b64decode(base64_data)

    # 출력 경로 결정
    if output_path is None:
        output_path = Path(json_path).stem + '.png'

    # PNG 저장
    with open(output_path, 'wb') as f:
        f.write(image_data)

    print(f"PNG 저장: {output_path} ({len(image_data):,} bytes)")
    return output_path


def resize_image(input_path: str, width: int, output_path: str = None) -> str:
    """sips를 사용하여 이미지 리사이즈 (macOS 전용)"""
    if output_path is None:
        p = Path(input_path)
        output_path = str(p.parent / f"{p.stem}_resized{p.suffix}")

    # sips로 리사이즈 (비율 유지, 최대 너비 지정)
    cmd = ['sips', '-Z', str(width), input_path, '--out', output_path]
    result = subprocess.run(cmd, capture_output=True, text=True)

    if result.returncode == 0:
        # 결과 파일 크기 확인
        size = Path(output_path).stat().st_size
        print(f"리사이즈 완료: {output_path} ({size:,} bytes)")
        return output_path
    else:
        print(f"리사이즈 실패: {result.stderr}", file=sys.stderr)
        return None


def get_image_dimensions(image_path: str) -> tuple:
    """sips를 사용하여 이미지 크기 확인"""
    result = subprocess.run(
        ['sips', '-g', 'pixelWidth', '-g', 'pixelHeight', image_path],
        capture_output=True, text=True
    )

    width = height = 0
    for line in result.stdout.split('\n'):
        if 'pixelWidth' in line:
            width = int(line.split(':')[1].strip())
        elif 'pixelHeight' in line:
            height = int(line.split(':')[1].strip())

    return width, height


def main():
    parser = argparse.ArgumentParser(
        description='스크린샷 변환 및 리사이즈 (JSON/이미지 파일 지원)'
    )
    parser.add_argument('input_file', help='입력 파일 경로 (JSON 또는 이미지)')
    parser.add_argument('output', nargs='?', help='출력 파일 경로')
    parser.add_argument('--resize', '-r', type=int, help='리사이즈할 너비 (픽셀)')

    args = parser.parse_args()

    input_path = args.input_file

    # 파일 타입에 따라 처리
    if is_image_file(input_path):
        # 이미지 파일: 리사이즈만 진행
        print(f"이미지 파일 감지: {input_path}")
        png_path = input_path

        # 이미지 크기 확인
        width, height = get_image_dimensions(png_path)
        print(f"이미지 크기: {width}x{height}")

        # 리사이즈
        if args.resize:
            output_path = args.output if args.output else None
            resized_path = resize_image(png_path, args.resize, output_path)
            if resized_path:
                new_width, new_height = get_image_dimensions(resized_path)
                print(f"리사이즈 후: {new_width}x{new_height}")
        else:
            print("--resize 옵션 없이 이미지 파일 입력. 리사이즈를 원하면 --resize 옵션 추가.")

    elif is_json_file(input_path):
        # JSON 파일 또는 확장자 없음: base64 추출 → PNG 변환
        print(f"JSON 파일 감지: {input_path}")

        # JSON → PNG 변환
        png_path = convert_json_to_png(input_path, args.output)

        # 이미지 크기 확인
        width, height = get_image_dimensions(png_path)
        print(f"이미지 크기: {width}x{height}")

        # 리사이즈 (옵션)
        if args.resize:
            resized_path = resize_image(png_path, args.resize)
            if resized_path:
                new_width, new_height = get_image_dimensions(resized_path)
                print(f"리사이즈 후: {new_width}x{new_height}")

    else:
        print(f"지원하지 않는 파일 형식: {input_path}", file=sys.stderr)
        sys.exit(1)


if __name__ == '__main__':
    main()
