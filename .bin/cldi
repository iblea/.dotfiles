#!/bin/bash

if [ -z "$(command -v claude)" ]; then
	echo "claude is not installed"
	echo "https://docs.claude.com/en/docs/claude-code/setup"
	echo "npm install -g @anthropic-ai/claude-code"
	echo "curl -fsSL 'https://claude.ai/install.sh' | bash"
	exit 1
fi

VIM_PROGRAM=""

NVIM_PATH="nvim"
VIM_PATH="vim"
SCROLLBACK=2500

# If nvim command exists, set nvim as the default.
# if [ -n "$(command -v $NVIM_PATH)" ]; then
#     VIM_PROGRAM="n"
# else
#     VIM_PROGRAM="o"
# fi
VIM_PROGRAM="n"

# VIM_DEFAULT=$(vim --version | head -n 1 | awk '{ print $1 }')
# if [ "$VIM_DEFAULT" = "NVIM" ]; then
#     VIM_PROGRAM="n"
# else
#     VIM_PROGRAM="o"
# fi


# VIM_PROGRAM -> n: neovim, o: original vim
# CLAUDE -> s: opus, a: sonnet

if [ $# -eq 0 ]; then
    pass
elif [ $# -eq 1 ]; then
    if [ "$1" = "n" ] || [ "$1" = "N" ]; then
        VIM_PROGRAM="n"
        shift
    elif [ "$1" = "o" ] || [ "$1" = "O" ]; then
        VIM_PROGRAM="o"
        shift
    fi
else
    # first option is vim argument
    if [ "$1" = "n" ] || [ "$1" = "N" ]; then
        VIM_PROGRAM="n"
        shift
    # first option is vim argument
    elif [ "$1" = "o" ] || [ "$1" = "O" ]; then
        VIM_PROGRAM="o"
        shift
    fi
fi

AGENT_COMMAND="$HOME/.dotfiles/.bin/cld"

# If vim terminal is already opend
# if [ -n "$VIMTERM" ] && [ "$VIMTERM" -eq "1" ]; then
# IS_VIMTERM="$(ps -p $PPID -o comm=)"
# if [ "$IS_VIMTERM" = "vim" ] || [ "$IS_VIMTERM" = "nvim" ]; then
if [ -n "$MYVIMRC" ]; then
    "$AGENT_COMMAND" $@
    exit 0
fi
# echo "args: '$@'"

if [ "$VIM_PROGRAM" = "n" ]; then
    # Properly escape arguments for bash -c
    ESCAPED_ARGS=$(printf '%q ' "$@")
        # -c "execute 'tnoremap <c-h> <LEFT>' | execute 'tnoremap <c-j> <DOWN>' | execute 'tnoremap <c-k> <UP>' | execute 'tnoremap <c-l> <RIGHT>' | execute 'tnoremap <c-z> <c-\><c-n><ESC>:suspend<cr>'" \
    $NVIM_PATH -c "set nonu | set nornu | set mouse=a | set scrollback=${SCROLLBACK} | set scrolloff=0 | execute 'nnoremap <c-o> <ESC>:call chansend(b:terminal_job_id, \"\<C-o>\")<CR>' | execute 'tnoremap <c-y> <c-\><c-n><ESC>pa | hi Normal guifg=#bcbcbc ctermfg=250'" \
        -c "execute 'tnoremap <c-h> <LEFT>' | execute 'tnoremap <c-j> <c-j>' | execute 'tnoremap <c-k> <Nop>' | execute 'tnoremap <c-l> <RIGHT>' | execute 'tnoremap <c-z> <c-\><c-n><ESC>:suspend<cr>'" \
        -c "execute 'nnoremap <c-r> <ESC>:set ft=c<CR>:set ft=markdown<CR>:RenderMarkdown<CR>' | execute 'nnoremap i <ESC>:set ft=none<CR>i'" \
        -c "terminal bash -c '${AGENT_COMMAND} ${ESCAPED_ARGS}; exit_code=\$?; exit \$exit_code'" \
        -c "autocmd TermClose * if v:event.status == 0 | quit | endif" \
        -c "startinsert"
    echo "neovim"
else
    # Properly escape arguments for vim terminal
    ESCAPED_ARGS=$(printf '%q ' "$@")
        # -c "execute 'tnoremap <c-h> <LEFT>' | execute 'tnoremap <c-j> <DOWN>' | execute 'tnoremap <c-k> <UP>' | execute 'tnoremap <c-l> <RIGHT>' | execute 'tnoremap <c-z> <c-\><c-n><ESC>:suspend<cr>' " \
    $VIM_PATH -c "set nonu | set nornu | set mouse=a | set termwinscroll=${SCROLLBACK} | set scrolloff=0 | execute 'nnoremap <c-o> <ESC>:call term_sendkeys(bufnr(\"%\"), \"\<C-o>\")<CR>i<C-\><C-n>' | execute 'tnoremap <c-y> <c-\><c-n><ESC>pa' | hi Normal guifg=#bcbcbc ctermfg=250'" \
        -c "execute 'tnoremap <c-h> <LEFT>' | execute 'tnoremap <c-l> <RIGHT>' | execute 'tnoremap <c-z> <c-\><c-n><ESC>:suspend<cr>'" \
        -c "execute 'tnoremap <c-h> <LEFT>' | execute 'tnoremap <c-j> <c-j>' | execute 'tnoremap <c-k> <Nop>' | execute 'tnoremap <c-l> <RIGHT>' | execute 'tnoremap <c-z> <c-\><c-n><ESC>:suspend<cr>' " \
        -c "set shell=$(which zsh | sed 's/ /\\ /g')" \
        -c "terminal ++close ++curwin bash -c \"${AGENT_COMMAND} ${ESCAPED_ARGS}; exit_code=\\\$?; exit \\\$exit_code\""
    # echo "original vim"
fi

exit 0
