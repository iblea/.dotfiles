#!/bin/bash


if [ -z "$(command -v fzf)" ]; then
    $HOME/.dotfiles/grepscript/agrepn "$@"
    eixt $?
fi

fzf_open_script="$HOME/.dotfiles/fzfscript/open_editor.sh"
fzf_execute="execute-silent"
if [ -z "$(command -v code)" ]; then
    fzf_execute="become"
fi
if [ -z "$(command -v code)" ] && [ -z "$(command -v vim)" ]; then
    $HOME/.dotfiles/grepscript/agrepn "$@"
    exit $?
fi

CURRENT_SHELL=$(ps -p $$ -o 'comm=')

# code -s > /dev/null
# if [ $? -ne 0 ]; then
#     return
# fi

is_argument="0"
findword=""
is_escape="0"
preview_script="$HOME/.dotfiles/fzfscript/cat_n_preview.sh"
if [[ "$1" = "-f" ]]; then
    preview_script="$HOME/.dotfiles/fzfscript/cat_m_preview.sh"
    is_argument="1"
    is_escape="1"
    if [ $# -gt 1 ]; then
        if [[ "$2" = "--" ]]; then
            findword="$3"
        else
            findword="$2"
        fi
    fi
elif [[ "$1" = "-m" ]]; then
    preview_script="$HOME/.dotfiles/fzfscript/cat_m_preview.sh"
    is_argument="1"
    is_escape="1"
    if [ $# -gt 1 ]; then
        if [[ "$2" = "--" ]]; then
            findword="$3"
        else
            findword="$2"
        fi
    fi
elif [[ "$1" = "-n" ]]; then
    is_argument="1"
    if [ $# -gt 1 ]; then
        if [[ "$2" = "--" ]]; then
            findword="$3"
        else
            findword="$2"
        fi
    fi
else
    is_argument="0"
    if [ $# -gt 0 ]; then
        if [[ "$1" = "--" ]]; then
            findword="$2"
        else
            findword="$1"
        fi
    fi
fi

if [ -z "$findword" ]; then
    read -p "find : " -r findword
fi


current_pwd="$(pwd)"

terminal_size=$(stty size < /dev/tty 2>/dev/null)
terminal_width=0
terminal_height=0

if [ -n "$terminal_size" ]; then
    terminal_width=$(echo $terminal_size | awk '{print $2}')
    terminal_height=$(echo $terminal_size | awk '{print $1}')
fi

preview_options="up:14" # 6
if [ $(echo "$terminal_width") -ge 200 ]; then
    preview_options="right"
else

    if [ $(echo "$terminal_height") -ge 24 ]; then
        preview_options="up:14" # 6 (6 + 6 + 1(highlight) + 1(wrap tmp len))
    elif [ $(echo "$terminal_height") -le 15 ]; then
        preview_options="up:6" # 2
    else
        # echo "11 - 10" | bc
        preview_height=$(expr ${terminal_height} - 9)
        preview_options="up:${preview_height}" # 2
    fi
fi



opts=( )
# $HOME/.dotfiles/fzfscript/grepff_logic.sh
reload_script="$HOME/.dotfiles/fzfscript/grepff_logic.sh"

find_word_escape=""
if [[ "$is_escape" = "1" ]]; then
    find_word_escape=${findword//\\/\\\\}
    reload_find_word=${find_word_escape//\"/\\\"}
else
    # find_word_escape=${findword//\\/\\\\}
    find_word_escape="$findword"
    reload_find_word="$find_word_escape"
fi

if [[ "$is_argument" = "1" ]]; then
    reload_script+=" $1 -- \"$reload_find_word\""
    opts=( "$1" "--" )
else
    reload_script+=" -n -- \"$reload_find_word\""
    opts=( "-n" "--" )
fi

RELOAD="reload:$reload_script"
# echo "RELOAD: $RELOAD"
# echo "findword: $findword"
# echo "find_word_escape: "$find_word_escape""
# echo "opts : ${opts[@]}"
# exit 0

# $reload_script | fzf \
~/.dotfiles/fzfscript/grepff_logic.sh "${opts[@]}" "${find_word_escape}" | fzf \
    --color hl+:underline \
    -e --ansi --read0 --cycle --info=inline  \
    --marker '═' --marker-multi-line '╔║╚' \
    --bind "ctrl-r:${RELOAD}" \
    --bind "ctrl-a:half-page-up" \
    --bind "ctrl-d:half-page-down" \
    --prompt 'grepff> ' \
    --delimiter '\n' \
    --preview "${preview_script} {1} " \
    --preview-window "${preview_options},wrap" \
    --bind "enter:${fzf_execute}( echo {1} | xargs -I{} ${fzf_open_script} ${current_pwd}/{} )"


    # search_string -> memset.*' -> error
    # --preview "${preview_script} '{1}' '$search_string'" \
    # --bind "enter:execute-silent(
    #     echo {1} | xargs -I{} code --goto ${current_pwd}/{}
    # )"
    # --preview-window 'up:6,wrap' \


# echo "${results}" | fzf -e --ansi --read0 --cycle --info=inline  \
#     --marker '═' --marker-multi-line '╔║╚' \
#     --bind "ctrl-a:half-page-up" \
#     --bind "ctrl-d:half-page-down" \
#     --bind "enter:execute-silent(echo {} | head -n 1 | xargs -I{} code --goto ${current_pwd}/{})"
#     # --bind "enter:execute-silent(echo {} | awk -F '\n' '{ print \$1 }' | xargs -I{} code --goto ${current_pwd}/{})"
#     # --bind "enter:execute-silent(echo {} | awk -F '    | ' '{print \$NF}' | xargs -I{} code --goto ${current_pwd}/{})"
#     #  | fzf -e --ansi --color=hl:#5FA392 --bind "ctrl-m:execute-silent(echo {} | cut -f -2 -d ':' | xargs code --goto)" --bind "enter:execute-silent(echo {} | cut -f -2 -d ':' | xargs code --goto)"
