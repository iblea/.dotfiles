# True color 지원
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-256color:Tc"

# VSCode 터미널에서 색상 쿼리 문자 제거
set -ga terminal-overrides ',*:Ss=\E[%p1%d q:Se=\E[2 q'
set-option -g allow-passthrough off

# 마우스 지원
set -g mouse on

# 히스토리
set -g history-limit 50000

# Esc 지연 제거
set -sg escape-time 0


# 윈도우/팬 번호 1부터
set -g base-index 1
setw -g pane-base-index 1

# 윈도우 닫을 때 번호 재정렬 (gap 없이 유지)
set -g renumber-windows on

# ========================================
# vim 스타일 복사 모드
# ========================================

# vi 모드
setw -g mode-keys vi

# Ctrl + x로 복사 모드 진입 (현재 커서 위치 유지)
bind-key -n C-x copy-mode -e

# Esc 키는 copy-mode에서 빠져나가지 않도록 설정 (선택 해제만)
bind-key -T copy-mode-vi Escape send-keys -X clear-selection

# Ctrl+x로 copy-mode 나가기
bind-key -T copy-mode-vi C-x send-keys -X cancel
bind-key -T copy-mode-vi 'i' send-keys -X cancel




# ~/.tmux.conf에 추가
# copy mode에서 맨 아래 도달 시 자동 종료 방지
set -g @scroll-down-exit-copy-mode off

# copy mode 설정
setw -g mode-keys vi

# copy mode에서 스크롤 끝 도달 시에도 유지
bind -T copy-mode-vi WheelDownPane send-keys -X -N 3 scroll-down \; copy-mode -e
bind -T copy-mode-vi WheelUpPane send-keys -X -N 3 scroll-up \; copy-mode -e

# copy mode에서 자동으로 빠져나가지 않도록 설정
unbind -T copy-mode-vi MouseDragEnd1Pane




# vim 스타일 키바인딩
bind-key -T copy-mode-vi 'v' send-keys -X begin-selection
bind-key -T copy-mode-vi 'V' send-keys -X select-line
bind-key -T copy-mode-vi 'r' send-keys -X rectangle-toggle
bind-key -T copy-mode-vi 'y' send-keys -X copy-selection

# Ctrl+a로 Half PageUp
bind-key -T copy-mode-vi -n C-a send-keys -X halfpage-up

# 스크롤 끝에서 copy-mode 유지 (자동 해제 방지)
# halfpage-down 후 강제로 copy-mode 재진입하여 유지
unbind-key -T copy-mode-vi -n C-d
bind-key -T copy-mode-vi -n C-d send-keys -X halfpage-down \; copy-mode -e
bind-key -T copy-mode-vi -n C-u send-keys -X halfpage-up
unbind-key -T copy-mode-vi -n C-g
bind-key -T copy-mode-vi -n C-g send-keys -X page-down \; copy-mode -e
bind-key -T copy-mode-vi -n C-b send-keys -X page-up

# 한 라인씩 스크롤 (기본 바인딩 제거 후 재설정)
unbind-key -T copy-mode-vi -n C-f
bind-key -T copy-mode-vi -n C-f send-keys -X scroll-up
unbind-key -T copy-mode-vi -n C-e
bind-key -T copy-mode-vi -n C-e send-keys -X scroll-down \; copy-mode -e

# ========================================
# 시스템 클립보드 연동 (플랫폼 자동 감지)
# ========================================
# macOS: pbcopy
# Linux (X11): xclip
# Linux (Wayland): wl-copy
# Windows (WSL): clip.exe
# copy-selection-and-cancel / copy-pipe-and-cancel: 복사 후 copy-mode-vi 종료
# copy-selection / copy-pipe: 복사 후 copy-mode-vi 유지

# y 키로 복사 (copy-mode 유지)
if-shell "command -v pbcopy > /dev/null 2>&1" \
  "bind-key -T copy-mode-vi 'y' send -X copy-pipe 'pbcopy'" \
  "if-shell 'command -v xclip > /dev/null 2>&1' \
    'bind-key -T copy-mode-vi \"y\" send -X copy-pipe \"xclip -in -selection clipboard\"' \
    'if-shell \"command -v wl-copy > /dev/null 2>&1\" \
      \"bind-key -T copy-mode-vi \\\"y\\\" send -X copy-pipe \\\"wl-copy\\\"\" \
      \"bind-key -T copy-mode-vi \\\"y\\\" send -X copy-pipe \\\"clip.exe\\\"\"'"

unbind-key -T copy-mode-vi -n Enter
# # Enter 키로 복사
# if-shell "command -v pbcopy > /dev/null 2>&1" \
#   "bind-key -T copy-mode-vi Enter send -X copy-pipe-and-cancel 'pbcopy'" \
#   "if-shell 'command -v xclip > /dev/null 2>&1' \
#     'bind-key -T copy-mode-vi Enter send -X copy-pipe-and-cancel \"xclip -in -selection clipboard\"' \
#     'if-shell \"command -v wl-copy > /dev/null 2>&1\" \
#       \"bind-key -T copy-mode-vi Enter send -X copy-pipe-and-cancel \\\"wl-copy\\\"\" \
#       \"bind-key -T copy-mode-vi Enter send -X copy-pipe-and-cancel \\\"clip.exe\\\"\"'"

# 마우스 드래그로 복사
if-shell "command -v pbcopy > /dev/null 2>&1" \
  "bind-key -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel 'pbcopy'" \
  "if-shell 'command -v xclip > /dev/null 2>&1' \
    'bind-key -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel \"xclip -in -selection clipboard\"' \
    'if-shell \"command -v wl-copy > /dev/null 2>&1\" \
      \"bind-key -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel \\\"wl-copy\\\"\" \
      \"bind-key -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel \\\"clip.exe\\\"\"'"




# ========================================
# Ctrl+Z로 tmux 클라이언트 suspend
# ========================================
bind-key -n C-z suspend-client


# bind-key -n S-Enter send-keys "\\" Enter
# bind-key -n C-Enter send-keys "\\" Enter


